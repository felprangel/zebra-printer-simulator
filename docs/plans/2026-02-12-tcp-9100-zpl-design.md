# Design: TCP 9100 ZPL Listener

## Objetivo
Adicionar um listener TCP na porta `9100` que receba ZPL, detecte o fim do payload pelo fechamento da conexão e renderize a etiqueta usando o mesmo fluxo do endpoint `/pstprnt`.

## Escopo
- Servidor TCP no mesmo processo do Express.
- Reuso da lógica de renderização atual (`Labelary -> PDF -> PNG -> Socket.IO`).
- Logs e eventos de erro compatíveis com o comportamento do endpoint HTTP.

## Arquitetura
O servidor HTTP atual continua ouvindo em `5001`. Um `net.Server` será criado no mesmo processo para aceitar conexões TCP na porta `9100`. Cada conexão representará um job de impressão. Os dados recebidos serão acumulados em buffer por conexão; ao evento `end`, o buffer será convertido para string e passado para a função compartilhada de renderização.

## Componentes
- `net.Server` (TCP 9100): recebe conexões, acumula dados, dispara o processamento no `end`.
- Função `renderZpl` (compartilhada): recebe `zplData` e executa o fluxo atual do `/pstprnt`.
- Socket.IO: emite `new_labels` ou `render_error`.

## Fluxo de Dados
1. Cliente conecta via TCP `9100` e envia ZPL.
2. Ao fechar a conexão, o servidor TCP considera o payload completo.
3. `renderZpl(zpl)` chama o Labelary, recebe PDF, converte para PNG com `pdf2pic`.
4. `io.emit("new_labels", { image_data_array })`.

## Tratamento de Erros
- ZPL vazio: log e descarte.
- Erro no Labelary: log detalhado e `io.emit("render_error", { error, details })`.
- Erro na conversão PDF->PNG: log e `render_error`.
- Limpeza de arquivo temporário garantida em `finally` quando aplicável.

## Concorrência e Limites
Múltiplas conexões simultâneas serão processadas em paralelo. Isso é aceitável para o simulador. Se necessário, uma próxima etapa pode adicionar fila ou limite de concorrência. Opcionalmente, podemos impor um limite máximo de bytes por conexão.

## Testes
Prioridade inicial: manter foco na implementação. Como próxima etapa:
- Testes unitários da função `renderZpl` com mocks de `axios` e `pdf2pic`.
- Teste de integração abrindo socket TCP, enviando ZPL e verificando emissão de eventos.
